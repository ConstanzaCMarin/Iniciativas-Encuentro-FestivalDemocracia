<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Iniciativas presentadas en el Encuentro Internacional de la Sociedad Civil del Festival Democracia (2025, Chile)*</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<!-- PapaParse para leer CSV en el navegador -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<!-- Tipografía -->
<link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --amarillo:#EDE643;
    --naranja:#F04C28;
    --negro:#26262B;
    --gris-frio:#CCCCD4;
    --azul-marino:#203445;
    --bg:#D4DADC;
  }
  html,body,*{font-family:"Roboto Condensed",system-ui,-apple-system,Segoe UI,Arial,sans-serif !important}
  html,body{height:100%;margin:0;background:var(--bg)}
  #map{position:fixed;inset:0}
  .leaflet-container{background:var(--bg)!important}

  /* Muevo el zoom a la esquina superior derecha */
  .leaflet-top.leaflet-left{left:auto!important;right:12px!important}
  .leaflet-control-zoom{margin-right:0!important;margin-left:0!important}

  /* Título */
  .caption{
    position:absolute;top:12px;left:12px;z-index:9999;
    color:var(--azul-marino);font-weight:700;font-size:16px;max-width:60vw;
    text-shadow:0 1px 0 rgba(255,255,255,.6);
  }
  /* Nota al pie (se oculta en móvil) */
  .footnote{
    position:absolute;right:12px;bottom:10px;z-index:9999;
    background:rgba(255,255,255,.85);border:1px solid var(--gris-frio);
    border-radius:8px;padding:6px 8px;color:var(--azul-marino);
    font-size:11px;line-height:1.15;max-width:36vw;pointer-events:none;
  }
  @media (max-width:640px){
    .caption{max-width:86vw;font-size:14px;line-height:1.15}
    .footnote{display:none}
  }

  /* Tooltip / Popup */
  .leaflet-tooltip.ttip{
    background:rgba(255,255,255,.97);
    border:1px solid var(--gris-frio);
    border-radius:10px;padding:10px 12px;color:var(--negro);
    box-shadow:0 2px 10px rgba(0,0,0,.06);max-width:420px
  }
  .leaflet-popup-content-wrapper{border-radius:12px;border:1px solid var(--gris-frio)}
  .leaflet-popup-content{margin:10px 12px}
  .tt-head{color:var(--naranja);font-weight:700;margin-bottom:6px}
  .tt-body{max-height:260px;overflow:auto}
  .tt-item{margin-bottom:8px}
  .tt-title{color:var(--negro)}
  .tt-meta{color:var(--negro);opacity:.95;font-size:12px}

  /* Etiqueta con el número naranja dentro de la burbuja */
  .id-label{
    white-space:nowrap;display:inline-block;text-align:center;line-height:1;pointer-events:none;
    position:relative;left:50%;top:50%;transform:translate(-50%,-61%); /* centrado óptico */
    color:var(--naranja);font-weight:700;font-size:11px;
  }
</style>
</head>
<body>
  <div id="map"></div>
  <div class="caption">Iniciativas presentadas en el Encuentro Internacional de la Sociedad Civil del Festival Democracia (2025, Chile)*</div>
  <div class="footnote">*Los números en los clusters representan la cantidad de iniciativas por país. En el listado emergente (hover/tap) cada iniciativa incluye su número del Anexo.</div>

<script>
(async function(){
  // --- Utilidades ---
  const cleanEnd = s=>{
    if(s==null) return "";
    s = String(s).trim();
    if(/^nan$/i.test(s)) return "";
    s = s.replace(/^['"“”„«»‹›‚‘’‐–—- ]+|['"“”„«»‹›‚‘’‐–—- ]+$/g,"");
    s = s.replace(/[\.·;:,!¡¿\?]+$/,"").trim();
    return s;
  };
  const normalize = s=>{
    if(!s) return "";
    return s.toString().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^a-z0-9 ]+/g," ").replace(/\s+/g," ").trim();
  };
  const orgDisplay = (orgRaw,country)=>{
    let oc = cleanEnd(orgRaw), n = normalize(oc);
    if(n==="sin informacion" || n==="sininformacion" || oc==="") return "";
    const excMX = normalize("Gobiernos locales y movimientos de izquierda");
    const excCL = normalize("Gobierno de Salvador Allende");
    if((country==="México" && n===excMX) || (country==="Chile" && n===excCL)) return oc;
    if(n.includes("gobierno")) return "Gubernamental";
    return oc;
  };

  // --- Coordenadas por país ---
  const coords = {
    "Brasil":[-14.2350,-51.9253],
    "Chile":[-33.4489,-70.6693],
    "Colombia":[4.5709,-74.2973],
    "España":[40.4637,-3.7492],
    "Francia":[46.2276,2.2137],
    "Guatemala":[15.7835,-90.2308],
    "México":[23.6345,-102.5528],
    "Suecia":[60.1282,18.6435],
    "Uruguay":[-32.5228,-55.7658]
  };

  // --- Anexo (para IDs; si tu CSV ya trae ID/AnexoID, el script lo usa y no necesita esto) ---
  const annexText = `
1.  Mejoras en la Escuelas Administración Pública (Chile)
2.  Acá el agua hierve también a 100 grados (Uruguay)
3.  Educación democrática en el sistema educativo (Suecia)
4.  Democracia y Derecho de Mujeres (Chile)
5.  Faro Progresista (Uruguay)
6.  Programa de formación Ciudadana (Chile)
7.  Hambre Cero (Brasil)
8.  Programa de democratización de acceso a la educación superior (Brasil)
9.  Comunidades energéticas (Colombia)
10. Política de Reforma Agraria (Colombia)
11. Cabildos Abiertos (Colombia)
12. Participación de la sociedad civil en política exterior (Chile)
13. Tem gente com fome! (Brasil)
14. Justicia Fiscal y justicia racial (Brasil)
15. Actuación Internacional para vigilancia de las elecciones (Brasil)
16. Museo de la Memoria y los Derechos Humanos (Chile)
17. Bolsa de Familia (Brasil)
18. Democracia Paritaria (Brasil)
19. Campaña sobre el Acuerdo de Escazú
20. Iniciativas de diálogo con redes de grupos religiosos (evangélicos)
21. Narrativas: Católicas por el Derecho a Decidir
22. Observatorio de ganancias de las empresas
23. Campañas para movilizar el voto joven (Brasil)
24. Ley de identidad de género (Chile y España)
25. Ley del AUGE (GES) (Chile)
26. Referéndum en Francia: mecanismos de Participación Ciudadana (Francia)
27. Políticas Públicas de Salvador Allende (Chile)
28. Utopías: Espacios Públicos Populares (México)
29. Políticas de Derechos Humanos (España)
30. Iniciativas Migratorias
31. Seguridad como Garantía para la Democracia
32. Memoria Democrática en la Educación
33. Fortalecimiento del proceso de descentralización (Chile)
34. Iniciativas populares durante el proceso constituyente (Chile)
35. Red Nacional de Protección a Comunicadores y Activistas (Brasil)
36. Fundação Lauro Campos e Marielle Franco (Brasil)
37. Foro Cono Sur (Uruguay)
38. Mecanismos para involucramiento de la ciudadanía en políticas públicas (Chile)
39. Autonomía estratégica para América Latina
40. Red regional de universidades contra la desinformación (Brasil)
41. Autogestión en el desarrollo del habitar (Chile)
42. Diplomacia ciudadana del sur global (Chile)
43. Cátedra ciudadana sobre antifascismo y DDHH (Chile)
44. Profundización de la democracia (Chile)
45. Sala de articulación contra la desinformación (Brasil)
46. El Frente Amplio te escucha (Uruguay)
47. Plan de formalización de la diplomacia (Chile)
48. Proyecto de condonación del CAE (Chile)
49. Sistema Nacional de Cuidados (Chile y Uruguay)
50. Plan Buen Vivir (Chile)
51. Reforma Pensional en Colombia (Colombia)
52. Barrio maestranza Ukamau (Chile)
53. Avenida comunidad (Guatemala)
54. Diálogos imposibles (México)
55. Democracia en plano digital (México)
56. Comunicación digital (Chile)
57. Seguridad pública (Chile)
58. Vivienda feminista (Chile)
59. Horizonte Ciudadano (Chile)
`.trim();

  const annex = annexText.split(/\n+/).map(line=>{
    const m = line.match(/^\s*(\d+)\.\s*(.+?)(?:\s*\(([^)]+)\))?$/);
    if(!m) return null;
    const id = +m[1];
    const title = cleanEnd((m[2]||"").replace(/\s*:\s*.*$/,""));
    const country = (m[3]||"").trim();
    return {id,title,country, norm:normalize(title)};
  }).filter(Boolean);

  // Jaccard simple
  const jacc = (a,b)=>{
    const A = new Set(a.split(" ").filter(Boolean));
    const B = new Set(b.split(" ").filter(Boolean));
    const inter = [...A].filter(x=>B.has(x)).length;
    return inter / (A.size || 1);
  };

  // --- Carga CSV ---
  const csvURL = "IniciativasFinal.csv"; // debe estar junto al index.html
  const parse = await new Promise((res,rej)=>{
    Papa.parse(csvURL,{
      download:true, header:true, delimiter:";",
      complete:res, error:rej, skipEmptyLines:true
    });
  });
  let rows = parse.data.map(r=>({
    Pais: (r["País"]??r["Pais"]??"").trim(),
    Nombre: cleanEnd(r["Nombre"]),
    Org: cleanEnd(r["Organización impulsora"]??r["Organizacion impulsora"]),
    AnnexID: cleanEnd(r["AnexoID"]??r["ID"])
  })).filter(r=>r.Pais && r.Pais!=="Internacional");

  // Si no viene ID en CSV, intentamos inferir con el Anexo
  if(!rows.some(r=>r.AnnexID)){
    rows.forEach(r=>{
      const n = normalize(r.Nombre);
      let best = {score:-1,id:null};
      for(const a of annex){
        let s = jacc(a.norm,n);
        if(a.country){
          const pc = normalize(r.Pais), ac = normalize(a.country);
          if(pc && (pc.includes(ac)||ac.includes(pc))) s += 0.1;
        }
        if(n.includes(a.norm) || a.norm.includes(n)) s += 0.1;
        if(s>best.score) best = {score:s,id:a.id};
      }
      r.AnnexID = (best.score>=0.35 && best.id) ? best.id : "";
    });
  }

  // --- Construcción de contenido por país ---
  const byCountry = {};
  for(const r of rows){
    if(!coords[r.Pais]) continue; // sin coordenadas no lo ubicamos
    byCountry[r.Pais] ??= {items:[], count:0};
    byCountry[r.Pais].items.push(r);
    byCountry[r.Pais].count++;
  }

  // --- Mapa ---
  const map = L.map('map',{
    center:[10,-25], zoom:2.2, minZoom:2, maxZoom:6, zoomControl:true, worldCopyJump:false,
    maxBounds:[[ -60, -180 ], [ 85, 180 ]]
  });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png',{
    attribution:'© CARTO', noWrap:true
  }).addTo(map);

  // --- Render de cada país ---
  const vals = Object.values(byCountry).map(v=>v.count);
  const mn = Math.min(...vals), mx = Math.max(...vals);
  const scale = n => (mx===mn) ? (13.5+51.3)/2 : 13.5 + (n-mn)*(51.3-13.5)/(mx-mn);

  const tooltipHTML = (country, list)=>{
    list.sort((a,b)=>(+a.AnnexID||1e9)-(+b.AnnexID||1e9));
    const head = `<div class="tt-head">${country} · ${list.length} iniciativas</div>`;
    const items = list.map(r=>{
      const title = cleanEnd(r.Nombre);
      const idtxt = r.AnnexID ? `#${r.AnnexID} | ` : "";
      const org = orgDisplay(r.Org, r.Pais);
      const meta = org ? `${org} — ${country}` : `${country}`;
      return `<div class="tt-item">
        <div class="tt-title">${idtxt}<b>${escapeHtml(title)}</b></div>
        <div class="tt-meta">${escapeHtml(meta)}</div>
      </div>`;
    }).join("");
    return `<div class="tt"><div class="tt-body">${head}${items}</div></div>`;
  };

  function escapeHtml(s){return (s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]))}

  for(const [country,data] of Object.entries(byCountry)){
    const [lat,lon] = coords[country];
    const r = scale(data.count);
    const tip = tooltipHTML(country,data.items);

    const circle = L.circleMarker([lat,lon],{
      radius:r, color:null, weight:0, fill:true, fillColor:"var(--amarillo)".replace("var(--amarillo)","#EDE643"),
      fillOpacity:.95
    }).addTo(map);

    circle.bindTooltip(tip,{sticky:true,className:"ttip"});
    const popup = L.popup({maxWidth:460}).setContent(tip);
    circle.bindPopup(popup);

    // etiqueta con el número sobre la burbuja
    L.marker([lat,lon],{
      icon:L.divIcon({className:"", html:`<div class="id-label">${data.count}</div>`})
    }).addTo(map);

    // móvil: click + touch abren el popup
    circle.on("click",()=>circle.openPopup());
    circle.on("touchstart",(e)=>{ e.originalEvent && e.originalEvent.preventDefault(); circle.openPopup(); });
  }

})();
</script>
</body>
</html>
